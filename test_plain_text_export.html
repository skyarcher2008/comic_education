<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导出纯文本功能测试</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>导出纯文本功能测试</h1>
    <button id="testExportBtn">测试导出纯文本</button>
    
    <script type="module">
        // 模拟状态数据
        const testState = {
            images: [
                {
                    file: { name: "page1.jpg" },
                    filename: "page1.jpg",
                    originalTexts: ["Hello", "World", "This is a test"],
                    bubbleTexts: ["你好", "世界", "这是一个测试"]
                },
                {
                    file: { name: "page2.png" },
                    filename: "page2.png", 
                    originalTexts: ["Good morning", "How are you?"],
                    bubbleTexts: ["早上好", "你好吗？"]
                },
                {
                    file: { name: "page3.jpg" },
                    filename: "page3.jpg",
                    originalTexts: ["Empty page"],
                    bubbleTexts: []
                }
            ]
        };
        
        // 模拟UI函数
        const testUI = {
            showGeneralMessage: function(message, type) {
                console.log(`[${type.toUpperCase()}] ${message}`);
                alert(`[${type.toUpperCase()}] ${message}`);
            }
        };
        
        // 导出纯文本函数（从main.js复制）
        function exportPlainText() {
            const allImages = testState.images;
            if (allImages.length === 0) {
                testUI.showGeneralMessage("没有可导出的图片文本", "warning");
                return;
            }

            // 准备导出文本内容
            let textContent = "漫画文本导出\n";
            textContent += "=" + "=".repeat(50) + "\n\n";
            
            let totalBubbles = 0;
            let totalImages = 0;
            
            // 遍历所有图片
            for (let imageIndex = 0; imageIndex < allImages.length; imageIndex++) {
                const image = allImages[imageIndex];
                const bubbleTexts = image.bubbleTexts || [];
                const originalTexts = image.originalTexts || [];
                
                // 跳过没有文本的图片
                if (originalTexts.length === 0 && bubbleTexts.length === 0) {
                    continue;
                }
                
                totalImages++;
                
                // 确定图片标识（优先使用文件名，否则使用索引）
                let imageIdentifier = `第${imageIndex + 1}页`;
                if (image.file && image.file.name) {
                    imageIdentifier = `第${imageIndex + 1}页 (${image.file.name})`;
                } else if (image.filename) {
                    imageIdentifier = `第${imageIndex + 1}页 (${image.filename})`;
                }
                
                textContent += `${imageIdentifier}\n`;
                textContent += "-".repeat(imageIdentifier.length) + "\n";
                
                // 获取文本的最大长度，用于对齐
                const maxLength = Math.max(originalTexts.length, bubbleTexts.length);
                
                if (maxLength === 0) {
                    textContent += "（无文本内容）\n\n";
                    continue;
                }
                
                // 遍历每个气泡的文本
                for (let bubbleIndex = 0; bubbleIndex < maxLength; bubbleIndex++) {
                    const original = originalTexts[bubbleIndex] || '';
                    const translated = bubbleTexts[bubbleIndex] || '';
                    
                    totalBubbles++;
                    
                    // 如果只有原文没有译文
                    if (original && !translated) {
                        textContent += `${bubbleIndex + 1}. ${original}\n`;
                        textContent += `   → （未翻译）\n\n`;
                    }
                    // 如果只有译文没有原文
                    else if (!original && translated) {
                        textContent += `${bubbleIndex + 1}. （无原文）\n`;
                        textContent += `   → ${translated}\n\n`;
                    }
                    // 如果原文和译文都有
                    else if (original && translated) {
                        textContent += `${bubbleIndex + 1}. ${original}\n`;
                        textContent += `   → ${translated}\n\n`;
                    }
                    // 如果原文和译文都没有（理论上不应该发生）
                    else {
                        textContent += `${bubbleIndex + 1}. （空内容）\n\n`;
                    }
                }
                
                textContent += "\n";
            }
            
            // 添加统计信息
            textContent += "=" + "=".repeat(50) + "\n";
            textContent += `导出统计：共 ${totalImages} 张图片，${totalBubbles} 个文本气泡\n`;
            textContent += `导出时间：${new Date().toLocaleString()}\n`;
            
            // 创建Blob并触发下载
            const blob = new Blob([textContent], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // 生成文件名（包含时间戳）
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
            a.download = `comic_text_${timestamp}.txt`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            testUI.showGeneralMessage(`纯文本导出成功！共导出 ${totalImages} 张图片的文本`, "success");
        }
        
        // 绑定测试按钮
        document.getElementById('testExportBtn').addEventListener('click', exportPlainText);
    </script>
</body>
</html>
